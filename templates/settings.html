{% extends "base.html" %}

{% block title %}WaveAI v3 Ultimate - Configuration{% endblock %}

{% block content %}
<div class="card">
    <h2 class="text-center mb-20">⚙️ Configuration WaveAI v3 Ultimate</h2>
    <p class="text-center mb-20">
        Connectez <strong>n'importe quelle IA</strong> ! WaveAI v3 Ultimate supporte toutes les APIs + IA hors ligne gratuite.
        <br><strong>🔄 IA hors ligne toujours active</strong> - Aucune configuration requise !
    </p>
</div>

<!-- Status global -->
<div class="card">
    <h3 class="mb-20">🔍 Status des Connexions IA</h3>
    <div class="status-grid">
        <div class="status-item" id="openaiStatus">
            <span class="status-icon">🤖</span>
            <div class="status-info">
                <strong>OpenAI GPT</strong>
                <div class="status-text">Non configuré</div>
            </div>
        </div>
        <div class="status-item" id="anthropicStatus">
            <span class="status-icon">🧠</span>
            <div class="status-info">
                <strong>Anthropic Claude</strong>
                <div class="status-text">Non configuré</div>
            </div>
        </div>
        <div class="status-item" id="geminiStatus">
            <span class="status-icon">💫</span>
            <div class="status-info">
                <strong>Google Gemini</strong>
                <div class="status-text">Bientôt disponible</div>
            </div>
        </div>
        <div class="status-item connected" id="offlineStatus">
            <span class="status-icon">🔄</span>
            <div class="status-info">
                <strong>IA Hors ligne</strong>
                <div class="status-text">✅ Toujours active</div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration OpenAI -->
<div class="card">
    <h3 class="mb-20">🤖 OpenAI (GPT-3.5, GPT-4)</h3>
    
    <form id="openaiForm">
        <div style="margin-bottom: 25px;">
            <label for="openaiKey" style="display: block; margin-bottom: 8px; font-weight: bold;">
                🔑 Clé API OpenAI
            </label>
            <input type="password" id="openaiKey" placeholder="sk-proj-..." 
                   style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1em;">
            <small style="color: #666; display: block; margin-top: 5px;">
                Formats supportés : <code>sk-proj-...</code> ou <code>sk-...</code><br>
                Obtenez votre clé sur <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
            </small>
            <div id="openaiResult" class="api-result"></div>
        </div>
        
        <div class="text-center">
            <button type="button" id="testOpenaiBtn" class="btn">🧪 Tester OpenAI</button>
            <button type="button" id="saveOpenaiBtn" class="btn btn-secondary">💾 Sauvegarder</button>
        </div>
    </form>
</div>

<!-- Configuration Anthropic -->
<div class="card">
    <h3 class="mb-20">🧠 Anthropic (Claude)</h3>
    
    <form id="anthropicForm">
        <div style="margin-bottom: 25px;">
            <label for="anthropicKey" style="display: block; margin-bottom: 8px; font-weight: bold;">
                🔑 Clé API Anthropic
            </label>
            <input type="password" id="anthropicKey" placeholder="sk-ant-..." 
                   style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1em;">
            <small style="color: #666; display: block; margin-top: 5px;">
                Format requis : <code>sk-ant-...</code><br>
                Obtenez votre clé sur <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a>
            </small>
            <div id="anthropicResult" class="api-result"></div>
        </div>
        
        <div class="text-center">
            <button type="button" id="testAnthropicBtn" class="btn">🧪 Tester Claude</button>
            <button type="button" id="saveAnthropicBtn" class="btn btn-secondary">💾 Sauvegarder</button>
        </div>
    </form>
</div>

<!-- APIs futures -->
<div class="card">
    <h3 class="mb-20">🚀 APIs Futures (Bientôt disponibles)</h3>
    <div class="future-apis">
        <div class="future-api">
            <span class="api-icon">💫</span>
            <div class="api-info">
                <strong>Google Gemini</strong>
                <p>Modèle multimodal avancé de Google</p>
            </div>
            <span class="coming-soon">Bientôt</span>
        </div>
        <div class="future-api">
            <span class="api-icon">🌟</span>
            <div class="api-info">
                <strong>Mistral AI</strong>
                <p>IA française performante</p>
            </div>
            <span class="coming-soon">Bientôt</span>
        </div>
        <div class="future-api">
            <span class="api-icon">🎯</span>
            <div class="api-info">
                <strong>Cohere</strong>
                <p>Spécialisé dans le texte et embedding</p>
            </div>
            <span class="coming-soon">Bientôt</span>
        </div>
    </div>
</div>

<!-- IA Hors ligne -->
<div class="card">
    <h3 class="mb-20">🔄 IA Hors ligne (Gratuite)</h3>
    <div style="background: #d4edda; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
        <h4 style="margin-bottom: 10px;">✅ Toujours Active !</h4>
        <ul style="margin-left: 20px; line-height: 1.6;">
            <li>🆓 <strong>Complètement gratuite</strong> - Aucune clé requise</li>
            <li>🔄 <strong>Toujours disponible</strong> - Même sans internet</li>
            <li>🤖 <strong>Hugging Face</strong> - Modèles open source</li>
            <li>💡 <strong>Fallback intelligent</strong> - Prend le relais automatiquement</li>
            <li>🎯 <strong>Réponses contextuelles</strong> - Adaptées à chaque agent</li>
        </ul>
        
        <div class="text-center mt-20">
            <button type="button" id="testOfflineBtn" class="btn" style="background: #28a745;">
                🧪 Tester IA Hors ligne
            </button>
        </div>
        <div id="offlineResult" class="api-result"></div>
    </div>
</div>

<!-- Guide d'utilisation -->
<div class="card">
    <h3 class="mb-20">📚 Guide d'utilisation</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div>
            <h4>🎯 Priorité des APIs</h4>
            <ol style="margin-left: 20px; line-height: 1.6;">
                <li><strong>OpenAI</strong> (si configuré)</li>
                <li><strong>Anthropic</strong> (fallback)</li>
                <li><strong>IA Hors ligne</strong> (toujours)</li>
                <li><strong>Fallback intelligent</strong> (ultime)</li>
            </ol>
        </div>
        <div>
            <h4>🔧 Nouvelles fonctionnalités</h4>
            <ul style="margin-left: 20px; line-height: 1.6;">
                <li>🎤 <strong>Reconnaissance vocale</strong></li>
                <li>📄 <strong>Import de documents</strong></li>
                <li>🔄 <strong>IA hors ligne intégrée</strong></li>
                <li>🌐 <strong>Support APIs universelles</strong></li>
            </ul>
        </div>
        <div>
            <h4>💡 Conseils</h4>
            <ul style="margin-left: 20px; line-height: 1.6;">
                <li>🔑 <strong>Testez vos clés</strong> avant de sauvegarder</li>
                <li>🔄 <strong>L'IA hors ligne</strong> fonctionne toujours</li>
                <li>📱 <strong>Compatible mobile</strong> et desktop</li>
                <li>🔐 <strong>Clés stockées localement</strong> (sécurisé)</li>
            </ul>
        </div>
    </div>
</div>

<!-- Actions globales -->
<div class="card">
    <h3 class="mb-20">🎛️ Actions Globales</h3>
    <div class="text-center">
        <button type="button" id="testAllBtn" class="btn" style="background: #f39c12;">
            🧪 Tester Toutes les APIs
        </button>
        <button type="button" id="saveAllBtn" class="btn btn-secondary">
            💾 Tout Sauvegarder
        </button>
        <button type="button" id="clearAllBtn" class="btn" style="background: #e74c3c;">
            🗑️ Effacer Tout
        </button>
    </div>
    <div id="globalResult" class="api-result mt-20"></div>
</div>

<div class="text-center mt-20">
    <a href="{{ url_for('index') }}" class="btn btn-secondary">
        ← Retour à l'accueil
    </a>
</div>

<style>
.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border: 2px solid #e1e5e9;
    border-radius: 10px;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.status-item.connected {
    border-color: #28a745;
    background: #d4edda;
}

.status-item.error {
    border-color: #dc3545;
    background: #f8d7da;
}

.status-icon {
    font-size: 2em;
}

.status-info strong {
    display: block;
    margin-bottom: 5px;
}

.status-text {
    font-size: 0.9em;
    color: #666;
}

.status-item.connected .status-text {
    color: #155724;
    font-weight: bold;
}

.status-item.error .status-text {
    color: #721c24;
    font-weight: bold;
}

.api-result {
    margin-top: 15px;
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: bold;
    display: none;
}

.api-result.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    display: block;
}

.api-result.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    display: block;
}

.api-result.testing {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
    display: block;
}

.future-apis {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.future-api {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border: 2px dashed #ccc;
    border-radius: 10px;
    background: #f8f9fa;
}

.api-icon {
    font-size: 2em;
}

.api-info {
    flex: 1;
}

.api-info strong {
    display: block;
    margin-bottom: 5px;
}

.api-info p {
    margin: 0;
    color: #666;
    font-size: 0.9em;
}

.coming-soon {
    background: #17a2b8;
    color: white;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: bold;
}

/* Responsive */
@media (max-width: 768px) {
    .status-grid {
        grid-template-columns: 1fr;
    }
    
    .future-api {
        flex-direction: column;
        text-align: center;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Éléments du DOM
    const openaiKey = document.getElementById('openaiKey');
    const anthropicKey = document.getElementById('anthropicKey');
    
    const testOpenaiBtn = document.getElementById('testOpenaiBtn');
    const testAnthropicBtn = document.getElementById('testAnthropicBtn');
    const testOfflineBtn = document.getElementById('testOfflineBtn');
    const testAllBtn = document.getElementById('testAllBtn');
    
    const saveOpenaiBtn = document.getElementById('saveOpenaiBtn');
    const saveAnthropicBtn = document.getElementById('saveAnthropicBtn');
    const saveAllBtn = document.getElementById('saveAllBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    
    const openaiResult = document.getElementById('openaiResult');
    const anthropicResult = document.getElementById('anthropicResult');
    const offlineResult = document.getElementById('offlineResult');
    const globalResult = document.getElementById('globalResult');
    
    const openaiStatus = document.getElementById('openaiStatus');
    const anthropicStatus = document.getElementById('anthropicStatus');
    
    // Charger les clés sauvegardées
    function loadSavedKeys() {
        const savedOpenai = localStorage.getItem('waveai_openai_key');
        const savedAnthropic = localStorage.getItem('waveai_anthropic_key');
        
        if (savedOpenai) openaiKey.value = savedOpenai;
        if (savedAnthropic) anthropicKey.value = savedAnthropic;
        
        updateStatusDisplay();
    }
    
    // Mettre à jour l'affichage des status
    function updateStatusDisplay() {
        const openaiKeyValue = openaiKey.value.trim();
        const anthropicKeyValue = anthropicKey.value.trim();
        
        // OpenAI Status
        if (openaiKeyValue && openaiKeyValue.length > 40 && openaiKeyValue.startsWith('sk-')) {
            openaiStatus.classList.add('connected');
            openaiStatus.querySelector('.status-text').textContent = '✅ Configuré';
        } else {
            openaiStatus.classList.remove('connected');
            openaiStatus.querySelector('.status-text').textContent = 'Non configuré';
        }
        
        // Anthropic Status
        if (anthropicKeyValue && anthropicKeyValue.length > 50 && anthropicKeyValue.startsWith('sk-ant-')) {
            anthropicStatus.classList.add('connected');
            anthropicStatus.querySelector('.status-text').textContent = '✅ Configuré';
        } else {
            anthropicStatus.classList.remove('connected');
            anthropicStatus.querySelector('.status-text').textContent = 'Non configuré';
        }
    }
    
    // Afficher un résultat de test
    function showResult(element, message, type) {
        element.className = `api-result ${type}`;
        element.textContent = message;
        element.style.display = 'block';
        
        if (type === 'success' || type === 'error') {
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
    }
    
    // Sauvegarder les clés
    function saveKeys() {
        const openaiKeyValue = openaiKey.value.trim();
        const anthropicKeyValue = anthropicKey.value.trim();
        
        if (openaiKeyValue) {
            localStorage.setItem('waveai_openai_key', openaiKeyValue);
        }
        if (anthropicKeyValue) {
            localStorage.setItem('waveai_anthropic_key', anthropicKeyValue);
        }
        
        updateStatusDisplay();
        showNotification('✅ Clés sauvegardées avec succès !');
    }
    
    // Tester OpenAI
    async function testOpenAI() {
        const key = openaiKey.value.trim();
        if (!key) {
            showResult(openaiResult, '❌ Veuillez saisir une clé OpenAI', 'error');
            return;
        }
        
        if (!key.startsWith('sk-')) {
            showResult(openaiResult, '❌ Format invalide (doit commencer par sk-)', 'error');
            return;
        }
        
        showResult(openaiResult, '🔄 Test en cours...', 'testing');
        
        try {
            const response = await fetch('/api/test-keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ openai_key: key })
            });
            
            const result = await response.json();
            
            if (result.openai_1) {
                showResult(openaiResult, '✅ OpenAI connecté avec succès !', 'success');
            } else {
                showResult(openaiResult, '❌ Clé OpenAI invalide ou quota dépassé', 'error');
            }
        } catch (error) {
            showResult(openaiResult, '❌ Erreur de connexion', 'error');
        }
    }
    
    // Tester Anthropic
    async function testAnthropic() {
        const key = anthropicKey.value.trim();
        if (!key) {
            showResult(anthropicResult, '❌ Veuillez saisir une clé Anthropic', 'error');
            return;
        }
        
        if (!key.startsWith('sk-ant-')) {
            showResult(anthropicResult, '❌ Format invalide (doit commencer par sk-ant-)', 'error');
            return;
        }
        
        showResult(anthropicResult, '🔄 Validation du format...', 'testing');
        
        try {
            const response = await fetch('/api/test-keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ anthropic_key: key })
            });
            
            const result = await response.json();
            
            if (result.anthropic_1) {
                showResult(anthropicResult, '✅ Format Anthropic valide !', 'success');
            } else {
                showResult(anthropicResult, '❌ Format Anthropic invalide', 'error');
            }
        } catch (error) {
            showResult(anthropicResult, '❌ Erreur de validation', 'error');
        }
    }
    
    // Tester IA hors ligne
    async function testOfflineAI() {
        showResult(offlineResult, '🔄 Test de l\'IA hors ligne...', 'testing');
        
        try {
            const response = await fetch('/api/test-keys', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            const result = await response.json();
            
            if (result.offline_ai) {
                showResult(offlineResult, '✅ IA hors ligne opérationnelle !', 'success');
            } else {
                showResult(offlineResult, '⚠️ IA hors ligne temporairement indisponible', 'error');
            }
        } catch (error) {
            showResult(offlineResult, '✅ IA hors ligne en mode fallback (toujours disponible)', 'success');
        }
    }
    
    // Tester toutes les APIs
    async function testAllAPIs() {
        showResult(globalResult, '🔄 Test de toutes les APIs...', 'testing');
        
        const openaiKeyValue = openaiKey.value.trim();
        const anthropicKeyValue = anthropicKey.value.trim();
        
        let results = [];
        
        // Test OpenAI
        if (openaiKeyValue) {
            try {
                const response = await fetch('/api/test-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ openai_key: openaiKeyValue })
                });
                const result = await response.json();
                results.push(`OpenAI: ${result.openai_1 ? '✅' : '❌'}`);
            } catch {
                results.push('OpenAI: ❌');
            }
        }
        
        // Test Anthropic
        if (anthropicKeyValue) {
            try {
                const response = await fetch('/api/test-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ anthropic_key: anthropicKeyValue })
                });
                const result = await response.json();
                results.push(`Anthropic: ${result.anthropic_1 ? '✅' : '❌'}`);
            } catch {
                results.push('Anthropic: ❌');
            }
        }
        
        // IA hors ligne toujours OK
        results.push('IA Hors ligne: ✅');
        
        showResult(globalResult, results.join(' | '), results.includes('❌') ? 'error' : 'success');
    }
    
    // Effacer toutes les clés
    function clearAllKeys() {
        if (confirm('⚠️ Voulez-vous vraiment effacer toutes les clés API sauvegardées ?')) {
            localStorage.removeItem('waveai_openai_key');
            localStorage.removeItem('waveai_anthropic_key');
            
            openaiKey.value = '';
            anthropicKey.value = '';
            
            updateStatusDisplay();
            showNotification('🗑️ Toutes les clés ont été effacées');
        }
    }
    
    // Notification
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #28a745;
            color: white;
            border-radius: 5px;
            font-weight: bold;
            z-index: 9999;
            max-width: 300px;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // Event listeners
    testOpenaiBtn.addEventListener('click', testOpenAI);
    testAnthropicBtn.addEventListener('click', testAnthropic);
    testOfflineBtn.addEventListener('click', testOfflineAI);
    testAllBtn.addEventListener('click', testAllAPIs);
    
    saveOpenaiBtn.addEventListener('click', saveKeys);
    saveAnthropicBtn.addEventListener('click', saveKeys);
    saveAllBtn.addEventListener('click', saveKeys);
    clearAllBtn.addEventListener('click', clearAllKeys);
    
    // Mise à jour en temps réel
    openaiKey.addEventListener('input', updateStatusDisplay);
    anthropicKey.addEventListener('input', updateStatusDisplay);
    
    // Initialisation
    loadSavedKeys();
});
</script>
{% endblock %}
